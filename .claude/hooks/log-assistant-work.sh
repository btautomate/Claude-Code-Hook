#!/bin/bash
# Claude Code Hook: Log Work Summary
# Trigger: Stop - Runs when Claude completes a response
# Purpose: Save summary of work done by Claude to WORKLOG.md

# Get the response content from stdin
INPUT=$(cat)

# Initialize work summary
WORK_SUMMARY=""

# Try to parse JSON and extract transcript path
if command -v jq &> /dev/null; then
    TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path // empty' 2>/dev/null)

    if [ -n "$TRANSCRIPT_PATH" ] && [ -f "$TRANSCRIPT_PATH" ]; then
        # Read JSONL transcript file (each line is a JSON object)
        # Extract all assistant messages and get the last one
        WORK_SUMMARY=$(cat "$TRANSCRIPT_PATH" | \
            jq -r 'select(.message.role == "assistant") | .message.content[]? | select(.type == "text") | .text' 2>/dev/null | \
            tail -1)
    fi

    # If no work summary found, use placeholder
    if [ -z "$WORK_SUMMARY" ] || [ "$WORK_SUMMARY" = "null" ]; then
        WORK_SUMMARY="[No assistant messages found in transcript]"
    fi
else
    # jq not installed - cannot parse JSON
    WORK_SUMMARY="[jq not installed - install with: sudo apt install jq (Linux) or brew install jq (macOS)]"
fi

# Get current timestamp (Vietnamese timezone GMT+7)
TIMESTAMP=$(TZ='Asia/Ho_Chi_Minh' date '+%Y-%m-%d %H:%M:%S')

# File to log work summaries
LOG_FILE="WORKLOG.md"
ARCHIVE_DIR="docs/claude_code"

# Auto-archive if file exceeds 1000 lines
if [ -f "$LOG_FILE" ]; then
    LINE_COUNT=$(wc -l < "$LOG_FILE" 2>/dev/null || echo 0)
    if [ "$LINE_COUNT" -gt 1000 ]; then
        # Create archive directory if it doesn't exist
        mkdir -p "$ARCHIVE_DIR"

        # Generate archive filename with timestamp
        ARCHIVE_TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
        ARCHIVE_FILE="$ARCHIVE_DIR/WORKLOG_$ARCHIVE_TIMESTAMP.md"

        # Move current file to archive
        mv "$LOG_FILE" "$ARCHIVE_FILE"
        echo "ðŸ“¦ Archived $LOG_FILE -> $ARCHIVE_FILE ($LINE_COUNT lines)" >&2
    fi
fi

# Create log file if it doesn't exist
if [ ! -f "$LOG_FILE" ]; then
    cat > "$LOG_FILE" << 'EOF'
# Claude Code Work Log
**Auto-generated by Claude Code Hook**

This file contains summaries of work completed by Claude Code, with timestamps.

---

EOF
fi

# Append the work summary to log file
cat >> "$LOG_FILE" << EOF

## ðŸ¤– Work Completed - $TIMESTAMP

$WORK_SUMMARY

---

EOF

# Echo the input back (required by Claude Code hooks)
echo "$INPUT"
